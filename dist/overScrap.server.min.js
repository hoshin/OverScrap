"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),express=require("express"),graphqlHTTP=require("express-graphql"),_=require("lodash"),Scrapper=require("../index"),schema=require("../graph/schema"),mockedData=require("../sampleData/example.json"),scrapper=new Scrapper,REFERENCE_KEYS=["MultikillBest","GamesTied","TimeSpentonFireMostinGame","OffensiveAssistsAvgper10Min","DamageBlockedAvgper10Min","TimeSpentonFireAvgper10Min","SoloKillsAvgper10Min","ObjectiveTimeAvgper10Min","ObjectiveKillsAvgper10Min","FinalBlowsAvgper10Min","EliminationsAvgper10Min","DeathsAvgper10Min","GamesLost"],OverScrapServer=function(){function e(r){var t=this;_classCallCheck(this,e),this.server=express(),this.server.get("/api",function(e, r){var n=e.query,s=n.tag,a=n.region,i=n.mode;s&&a&&i||r.status(400).json({error:"Invalid parameters, missing at least tag, region or mode query param"}),t.scrap(e.query.tag,e.query.region,e.query.gameMode).then(function(e){r.json(e)})}),this.server.use("/graphql",graphqlHTTP({schema:schema,rootValue:{statsByHeroName:function(e){return t.scrap(e.battleTag,e.region,e.mode).then(function(r){var t=void 0,n=(t=_.filter(r.heroesStats,function(r,t){return t===e.heroName}))[0];return _.forEach(n,function(e,r){var t=r.replace(/[ \-]/g,"");n[t]=e,_.forEach(Object.keys(e),function(r){var t=r.replace(/[ \-]/g,"");e[t]=e[r]})}),_.forEach(n.Miscelaneous,function(e,r){REFERENCE_KEYS.indexOf(r)<0&&(n.HeroSpecific.misc||(n.HeroSpecific.misc={}),n.HeroSpecific.misc[r]=e,delete n.Miscelaneous[r])}),{name:e.heroName,HeroSpecific:{raw:n.HeroSpecific},Combat:n.Combat,Assists:n.Assists,Best:n.Best,Average:n.Average,Deaths:n.Deaths.Deaths,MatchAwards:n.MatchAwards,Game:n.Game,Miscelaneous:n.Miscelaneous}})},statByName:function(e){}},graphiql:!0})),this.port=r.port}return _createClass(e,[{key:"scrap",value:function(e,r,t){return"production"===process.env.OVERSCRAP_ENV?scrapper.loadDataFromProfile(e,r,t):Promise.resolve(mockedData)}},{key:"start",value:function(){var e=this;return!this.instance&&(this.instance=this.server.listen(this.port,function(){console.log("Server running on port:"+e.instance.address().port)}),!0)}},{key:"stop",value:function(){var e=this;return!!this.instance&&(this.instance.close(function(){delete e.instance,console.log("Server shutdown complete")}),!0)}}]),e}(),initServer=function(e){return new OverScrapServer(e)};module.exports=initServer;