"use strict";var _createClass=function(){function t(e,r){for(var a=0;a<r.length;a++){var t=r[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(e,r,a){return r&&t(e.prototype,r),a&&t(e,a),e}}();function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var express=require("express"),graphqlHTTP=require("express-graphql"),Scrapper=require("../index"),schema=require("../graph/schema"),converter=require("../graph/gqlConverter"),mockedData=require("../sampleData/example.json")||{},scrapper=new Scrapper,OverScrapServer=function(){function r(e){var o=this;_classCallCheck(this,r),this.server=express(),this.server.get("/api",function(e,r){var a=e.query,t=a.tag,s=a.region,n=a.mode;t&&s&&n||r.status(400).json({error:"Invalid parameters, missing at least tag, region or mode query param"}),o.scrap(e.query.tag,e.query.region,e.query.gameMode).then(function(e){r.json(e)})}),this.server.use("/graphql",graphqlHTTP({schema:schema,rootValue:{statsByHeroName:function(t){return o.scrap(t.battleTag,t.region,t.mode).then(function(e){var r=converter.selectHeroStats(e.heroesStats,t.heroName),a=converter.compressHeroDataKeys(r);return converter.moveHeroSpecificDataFromMiscToHeroSpecific(a),{name:t.heroName,heroSpecific:{raw:a.heroSpecific},combat:a.combat,assists:a.assists,best:a.best,average:a.average,deaths:a.deaths?a.deaths.deaths:null,matchAwards:a.matchAwards,game:a.game,miscellaneous:a.miscellaneous,kdr:a.kdr,raw:e}})}},graphiql:!0})),this.port=e.port}return _createClass(r,[{key:"scrap",value:function(e,r,a){return"production"===process.env.OVERSCRAP_ENV?scrapper.loadDataFromProfile(e,r,a):Promise.resolve(mockedData)}},{key:"start",value:function(){var e=this;return!this.instance&&(this.instance=this.server.listen(this.port,function(){console.log("Server running on port:"+e.instance.address().port)}),!0)}},{key:"stop",value:function(){var e=this;return!!this.instance&&(this.instance.close(function(){delete e.instance,console.log("Server shutdown complete")}),!0)}}]),r}(),initServer=function(e){return new OverScrapServer(e)};module.exports=initServer;