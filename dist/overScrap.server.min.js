"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var s=0;s<r.length;s++){var t=r[s];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,s,t){return s&&e(r.prototype,s),t&&e(r,t),r}}(),express=require("express"),graphqlHTTP=require("express-graphql"),_=require("lodash"),Scrapper=require("../index"),schema=require("../graph/schema"),mockedData=require("../sampleData/example.json")||{},scrapper=new Scrapper,REFERENCE_KEYS=["MultikillBest","GamesTied","TimeSpentonFireMostinGame","OffensiveAssistsAvgper10Min","DamageBlockedAvgper10Min","TimeSpentonFireAvgper10Min","SoloKillsAvgper10Min","ObjectiveTimeAvgper10Min","ObjectiveKillsAvgper10Min","FinalBlowsAvgper10Min","EliminationsAvgper10Min","DeathsAvgper10Min","GamesLost"],OverScrapServer=function(){function e(r){var s=this;_classCallCheck(this,e),this.server=express(),this.server.get("/api",function(e,r){var t=e.query,a=t.tag,n=t.region,i=t.mode;a&&n&&i||r.status(400).json({error:"Invalid parameters, missing at least tag, region or mode query param"}),s.scrap(e.query.tag,e.query.region,e.query.gameMode).then(function(e){r.json(e)})}),this.server.use("/graphql",graphqlHTTP({schema:schema,rootValue:{statsByHeroName:function(e){return s.scrap(e.battleTag,e.region,e.mode).then(function(r){var s=void 0,t=(s=_.filter(r.heroesStats,function(r,s){return s===e.heroName}))[0];return _.forEach(t,function(e,r){var s=r.replace(/[ \-]/g,"");t[s]=e,_.forEach(Object.keys(e),function(r){var s=r.replace(/[ \-]/g,"");e[s]=e[r]})}),_.forEach(t.Miscelaneous,function(e,r){REFERENCE_KEYS.indexOf(r)<0&&(t.HeroSpecific.misc||(t.HeroSpecific.misc={}),t.HeroSpecific.misc[r]=e,delete t.Miscelaneous[r])}),{name:e.heroName,HeroSpecific:{raw:t.HeroSpecific},Combat:t.Combat,Assists:t.Assists,Best:t.Best,Average:t.Average,Deaths:t.Deaths.Deaths,MatchAwards:t.MatchAwards,Game:t.Game,Miscelaneous:t.Miscelaneous}})}},graphiql:!0})),this.port=r.port}return _createClass(e,[{key:"scrap",value:function(e,r,s){return"production"===process.env.OVERSCRAP_ENV?scrapper.loadDataFromProfile(e,r,s):Promise.resolve(mockedData)}},{key:"start",value:function(){var e=this;return!this.instance&&(this.instance=this.server.listen(this.port,function(){console.log("Server running on port:"+e.instance.address().port)}),!0)}},{key:"stop",value:function(){var e=this;return!!this.instance&&(this.instance.close(function(){delete e.instance,console.log("Server shutdown complete")}),!0)}}]),e}(),initServer=function(e){return new OverScrapServer(e)};module.exports=initServer;