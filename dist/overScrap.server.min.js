"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var a=0;a<r.length;a++){var t=r[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,a,t){return a&&e(r.prototype,a),t&&e(r,t),r}}(),express=require("express"),graphqlHTTP=require("express-graphql"),Scrapper=require("../index"),schema=require("../graph/schema"),converter=require("../graph/gqlConverter"),mockedData=require("../sampleData/example.json")||{},scrapper=new Scrapper,OverScrapServer=function(){function e(r){var a=this;_classCallCheck(this,e),this.server=express(),this.server.get("/api",function(e,r){var t=e.query,s=t.tag,n=t.region,o=t.mode;s&&n&&o||r.status(400).json({error:"Invalid parameters, missing at least tag, region or mode query param"}),a.scrap(e.query.tag,e.query.region,e.query.gameMode).then(function(e){r.json(e)})}),this.server.use("/graphql",graphqlHTTP({schema:schema,rootValue:{statsByHeroName:function(e){return a.scrap(e.battleTag,e.region,e.mode).then(function(r){var a=converter.selectHeroStats(r.heroesStats,e.heroName),t=converter.compressHeroDataKeys(a);return converter.moveHeroSpecificDataFromMiscToHeroSpecific(t),{name:e.heroName,heroSpecific:{raw:t.heroSpecific},combat:t.combat,assists:t.assists,best:t.best,average:t.average,deaths:t.deaths?t.deaths.deaths:null,matchAwards:t.matchAwards,game:t.game,miscellaneous:t.miscellaneous,kdr:t.kdr,raw:r}})}},graphiql:!0})),this.port=r.port}return _createClass(e,[{key:"scrap",value:function(e,r,a){return"production"===process.env.OVERSCRAP_ENV?scrapper.loadDataFromProfile(e,r,a):Promise.resolve(mockedData)}},{key:"start",value:function(){var e=this;return!this.instance&&(this.instance=this.server.listen(this.port,function(){console.log("Server running on port:"+e.instance.address().port)}),!0)}},{key:"stop",value:function(){var e=this;return!!this.instance&&(this.instance.close(function(){delete e.instance,console.log("Server shutdown complete")}),!0)}}]),e}(),initServer=function(e){return new OverScrapServer(e)};module.exports=initServer;