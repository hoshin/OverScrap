"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),cheerio=require("cheerio"),Promise=require("bluebird"),request=require("request-promise"),_=require("lodash"),DEFAULT_REGION="eu",DEFAULT_GAME_MODE="competitive",OverScrap=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"getCategoryName",value:function(e,r){var t=_.get(e,"["+r+"].children[0].children[0].children[0].children");return t?_.get(t.filter(function(e){return"stat-title"===e.attribs.class}),"[0].children[0].data"):"Unknown"}},{key:"computeStatsByHero",value:function(e,r){var t=this,n=function(e){return _.get(r,"["+e+"].children[1].children",[])},a=function(e){return e.children[0].children[0].data},i=function(e){return e.children[1].children[0].data};return r.length&&e.name?{name:e.name,stats:r.reduce(function(e,o,u){return e[t.getCategoryName(r,u)]=n(u).reduce(function(e,r){return e[a(r)]=i(r),e},{}),e},{})}:null}},{key:"getHeroListForGameMode",value:function(e,r){var t=function(){return e("div#"+r+' section div div [data-js="career-select"][data-group-id="stats"]')[0].children};return new Promise(function(e,r){try{e(t().map(function(e){return{id:e.attribs.value,name:e.attribs["option-id"]}}))}catch(e){r(new Error("No hero list found for specified game mode"))}})}},{key:"getHeroStatsForGameMode",value:function(e,r,t){var n=this,a=function(e){return r("div#"+t+' section div [data-group-id="stats"][data-category-id="'+e.id+'"] div div.card-stat-block table.data-table').toArray()};return Promise.map(e,function(e){return n.computeStatsByHero(e,a(e))}).then(function(e){return e.reduce(function(e,r){return e[r.name]=r.stats,e},{})})}},{key:"appendProfileData",value:function(e,r){var t=e("div.competitive-rank div").first().text();return new Promise(function(e){e({profile:{currentSR:t},heroesStats:r})})}},{key:"loadRawFromProfile",value:function(e,r,t){var n=this,a=void 0;return!e||(a=e.split("#")).length<2?Promise.reject(new Error("Invalid tag")):request.get({uri:"https://playoverwatch.com/en-us/career/pc/"+(r||DEFAULT_REGION)+"/"+a[0]+"-"+a[1]}).then(function(e){var r=t||DEFAULT_GAME_MODE,a=cheerio.load(e);return n.getHeroListForGameMode(a,r).then(function(e){return n.getHeroStatsForGameMode(e,a,r)}).then(function(e){return n.appendProfileData(a,e)})})}},{key:"loadDataFromProfile",value:function(e,r,t){return this.loadRawFromProfile(e,r,t).then(function(e){return _.forEach(e.heroesStats,function(e){_.forEach(e,function(e){_.forEach(e,function(r,t){var n=void 0;try{n=parseFloat(r.replace(/,/g,""))}finally{(n||0===n)&&(e[t]=n)}})})}),e})}}]),e}();module.exports=OverScrap;