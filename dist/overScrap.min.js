"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(r,t,o){return t&&e(r.prototype,t),o&&e(r,o),r}}(),cheerio=require("cheerio"),Promise=require("bluebird"),request=require("request-promise"),_=require("lodash"),DEFAULT_REGION="eu",DEFAULT_GAME_MODE="competitive",OVERWATCH_URL_PREFIX="https://playoverwatch.com/en-us/career/pc/",OverScrap=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"computeStatsByHero",value:function(e,r){var t=this;return r.length&&e.name?{name:e.name,stats:r.reduce(function(e,o,n){return e[t.domHelper.getCategoryName(r,n)]=t.domHelper.getStatsInCategoryForHero(r,n).reduce(function(e,r){return e[t.domHelper.getStatName(r)]=t.domHelper.getStatValue(r),e},{}),e},{})}:null}},{key:"getHeroListForGameMode",value:function(e){var r=this;return new Promise(function(t,o){try{t(r.domHelper.getHeroListForPlayerAndGameMode(e).map(function(e){return{id:e.attribs.value,name:e.attribs["option-id"]}}))}catch(e){o(new Error("No hero list found for specified game mode"))}})}},{key:"getHeroStatsForGameMode",value:function(e,r){var t=this;return Promise.map(e,function(e){return t.computeStatsByHero(e,t.domHelper.getStatsContainerForHeroAndGameMode(e,r))}).then(function(e){return e.reduce(function(e,r){return e[r.name]=r.stats,e},{})})}},{key:"appendProfileData",value:function(e){var r=this.domHelper.getProfileSR();return new Promise(function(t){t({profile:{currentSR:r},heroesStats:e})})}},{key:"loadRawFromProfile",value:function(e,r,t){var o=this,n=void 0;return!e||(n=e.split("#")).length<2?Promise.reject(new Error("Invalid tag")):request.get({uri:""+OVERWATCH_URL_PREFIX+(r||DEFAULT_REGION)+"/"+n[0]+"-"+n[1]}).then(function(e){var r=t||DEFAULT_GAME_MODE;return o.domHelper=require("./helpers/domHelper").DomHelper(cheerio.load(e)),o.getHeroListForGameMode(r).then(function(e){return o.getHeroStatsForGameMode(e,r)}).then(function(e){return o.appendProfileData(e)})})}},{key:"loadDataFromProfile",value:function(e,r,t){return this.loadRawFromProfile(e,r,t).then(function(e){return _.forEach(e.heroesStats,function(e){_.forEach(e,function(e){_.forEach(e,function(r,t){var o=void 0;try{o=parseFloat(r.replace(/,/g,""))}finally{(o||0===o)&&(e[t]=o)}})})}),e})}}]),e}();module.exports=OverScrap;