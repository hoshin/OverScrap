"use strict";var _createClass=function(){function o(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,r,t){return r&&o(e.prototype,r),t&&o(e,t),e}}();function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var cheerio=require("cheerio"),Promise=require("bluebird"),request=require("request-promise"),_=require("lodash"),DEFAULT_REGION="eu",DEFAULT_GAME_MODE="competitive",OVERWATCH_URL_PREFIX="https://playoverwatch.com/en-us/career/pc/",OverScrap=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"computeStatsByHero",value:function(e,o){var n=this;if(!o.length||!e.name)return null;var r={name:e.name,stats:o.reduce(function(e,r,t){return e[n.domHelper.getCategoryName(o,t)]=n.domHelper.getStatsInCategoryForHero(o,t).reduce(function(e,r){return e[n.domHelper.getStatName(r)]=n.domHelper.getStatValue(r),e},{}),e},{})};_.forEach(r.stats,function(o){_.forEach(o,function(e,r){var t=void 0;try{"string"==typeof e&&(t=parseFloat(e.replace(/,/g,"")))}finally{(t||0===t)&&(o[r]=t)}})});var t=r.stats.Combat;if(t){var a=t.Eliminations,i=t.Deaths;r.stats.kdr=i?a?Math.floor(t.Eliminations/t.Deaths*100)/100:0:a}else r.stats.kdr=0;return r}},{key:"getHeroListForGameMode",value:function(t){var o=this;return new Promise(function(e,r){try{e(o.domHelper.getHeroListForPlayerAndGameMode(t).map(function(e){return{id:e.attribs.value,name:e.attribs["option-id"]}}))}catch(e){r(new Error("No hero list found for specified game mode"))}})}},{key:"getHeroStatsForGameMode",value:function(e,r){var t=this;return Promise.map(e,function(e){return t.computeStatsByHero(e,t.domHelper.getStatsContainerForHeroAndGameMode(e,r))}).then(function(e){return e.reduce(function(e,r){return e[r.name]=r.stats,e},{})})}},{key:"appendProfileData",value:function(r){var t=this.domHelper.getProfileSR();return new Promise(function(e){e({profile:{currentSR:t},heroesStats:r})})}},{key:"loadDataFromProfile",value:function(e,r,t){var o=this,n=void 0;return!e||(n=e.split("#")).length<2?Promise.reject(new Error("Invalid tag")):request.get({uri:""+OVERWATCH_URL_PREFIX+(r||DEFAULT_REGION)+"/"+n[0]+"-"+n[1]}).then(function(e){var r=t||DEFAULT_GAME_MODE;return o.domHelper=require("./helpers/domHelper").DomHelper(cheerio.load(e)),o.getHeroListForGameMode(r).then(function(e){return o.getHeroStatsForGameMode(e,r)}).then(function(e){return o.appendProfileData(e)})})}}]),e}();module.exports=OverScrap;